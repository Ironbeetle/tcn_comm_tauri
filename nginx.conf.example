# TCN_COMM Nginx Configuration
# Location: /etc/nginx/sites-available/tcn-comm
# 
# This runs TCN_COMM on a subdomain or path alongside the portal
# Choose ONE of the options below

# ===========================================
# OPTION 1: Subdomain (Recommended)
# ===========================================
# Access via: https://staff.yourdomain.com
# 
# server {
#     listen 80;
#     server_name staff.yourdomain.com;
#     return 301 https://$server_name$request_uri;
# }
# 
# server {
#     listen 443 ssl http2;
#     server_name staff.yourdomain.com;
# 
#     ssl_certificate /etc/letsencrypt/live/staff.yourdomain.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/staff.yourdomain.com/privkey.pem;
# 
#     location / {
#         proxy_pass http://localhost:3001;
#         proxy_http_version 1.1;
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection 'upgrade';
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_cache_bypass $http_upgrade;
#     }
# }

# ===========================================
# OPTION 2: Path-based (Add to existing server block)
# ===========================================
# Access via: https://yourdomain.com/staff
# Add this location block to your existing portal nginx config

# location /staff {
#     rewrite ^/staff(.*)$ $1 break;
#     proxy_pass http://localhost:3001;
#     proxy_http_version 1.1;
#     proxy_set_header Upgrade $http_upgrade;
#     proxy_set_header Connection 'upgrade';
#     proxy_set_header Host $host;
#     proxy_set_header X-Real-IP $remote_addr;
#     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#     proxy_set_header X-Forwarded-Proto $scheme;
#     proxy_cache_bypass $http_upgrade;
# }

# ===========================================
# OPTION 3: Internal Only (No public access)
# ===========================================
# Access via: http://VPS_IP:3001 or localhost:3001
# No nginx config needed - PM2 exposes port 3001 directly
# Use SSH tunnel or VPN for secure access:
#   ssh -L 3001:localhost:3001 user@your-vps-ip
# Then access: http://localhost:3001 from your local machine

# ===========================================
# COMPLETE EXAMPLE: Both apps on same server
# ===========================================
# Portal on port 3000, TCN_COMM on port 3001

server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;
    
    # Redirect HTTP to HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name yourdomain.com www.yourdomain.com;

    # SSL Configuration (adjust paths as needed)
    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;

    # Portal (Community Members) - Port 3000
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400;
    }
}

# Staff App - Separate subdomain
server {
    listen 80;
    server_name staff.yourdomain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name staff.yourdomain.com;

    ssl_certificate /etc/letsencrypt/live/staff.yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/staff.yourdomain.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;

    # TCN_COMM (Staff) - Port 3001
    location / {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400;
    }
}
